name: Push Minimal Images to Docker registry

on:
  push:
    branches:
      - main
  release:
    types:
      - created
  workflow_dispatch:  # Allow manual triggering

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com/tekintian/dev
  IMAGE_NAME: wine

jobs:
  # Build matrix for minimal images (Dockerfile.minimal)
  build-minimal:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant:
          - name: wine_dev-stable
            target: ubuntu-base
            arch: win64
            push_tag: wine_dev-stable
          - name: wine_dev-stable-py
            target: python
            arch: win64
            push_tag: wine_dev-stable-py
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Build ${{ matrix.variant.name }}
        run: |
          docker buildx build \
            -f Dockerfile.minimal \
            --target ${{ matrix.variant.target }} \
            -t ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }} \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --build-arg USE_CN_MIRRORS=0 \
            --load \
            .

      - name: Push ${{ matrix.variant.push_tag }}
        run: |
          docker push ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }}

      - name: Tag and push with release version
        if: github.event.release.tag_name != ''
        run: |
          docker tag ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }} \
                     ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }}-${{ github.event.release.tag_name }}
          docker push ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }}-${{ github.event.release.tag_name }}

  # Build minimal images with Wine 10 (from source - using Dockerfile.source)
  build-minimal-wine10:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant:
          - name: wine_dev-10.0
            target: ubuntu-base
            arch: win64
            push_tag: wine_dev-10.0
          - name: wine_dev-10.0-py
            target: python
            arch: win64
            push_tag: wine_dev-10.0-py
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Build ${{ matrix.variant.name }}
        run: |
          docker buildx build \
            -f Dockerfile.source \
            --target ${{ matrix.variant.target }} \
            -t ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }} \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --build-arg WINE_SOURCE_VERSION=wine-10.0 \
            --build-arg WINE_BRANCH=stable \
            --build-arg USE_CN_MIRRORS=0 \
            --load \
            .

      - name: Push ${{ matrix.variant.push_tag }}
        run: |
          docker push ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }}

      - name: Tag and push with release version
        if: github.event.release.tag_name != ''
        run: |
          docker tag ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }} \
                     ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }}-${{ github.event.release.tag_name }}
          docker push ${{ env.REGISTRY }}:${{ matrix.variant.push_tag }}-${{ github.event.release.tag_name }}
  # Summary job
  summary:
    runs-on: ubuntu-latest
    needs: [build-minimal, build-minimal-wine10]
    if: always()
    steps:
      - name: Build summary
        run: |
          echo "## Minimal Images Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All minimal Docker images have been built and pushed to Aliyun Container Registry." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Minimal Images (Official Precompiled)" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_dev-stable" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_dev-stable-py" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Minimal Images (From Source)" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_dev-10.0" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_dev-10.0-py" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Naming Convention:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`wine_dev-stable\` - Official precompiled Wine (latest stable)" >> $GITHUB_STEP_SUMMARY
          echo "- \`wine_dev-<version>\` - Built from source (e.g., wine_dev-10.0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Example" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_dev-stable" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
