name: Push to Docker registry

on:
  push:
    branches:
      - main
  release:
    types:
      - created
  workflow_dispatch:  # Allow manual triggering

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com/tekintian/dev
  IMAGE_NAME: wine

jobs:
  # Build matrix for stable branch
  build-stable:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant:
          - name: latest
            target: ubuntu-base
            arch: win64
            make_target: build
            push_tag: latest
          - name: ubuntu-win32
            target: ubuntu-base
            arch: win32
            make_target: build-ubuntu-win32
            push_tag: ubuntu-win32
          - name: ubuntu-py311
            target: python
            arch: win64
            make_target: build-ubuntu-py311
            push_tag: ubuntu-py311
          - name: ubuntu-win32-py311
            target: python
            arch: win32
            make_target: build-ubuntu-win32-py311
            push_tag: ubuntu-win32-py311
          - name: nvidia
            target: ubuntu-base
            arch: win64
            make_target: build-nvidia
            push_tag: nvidia
          - name: nvidia-win32
            target: ubuntu-base
            arch: win32
            make_target: build-nvidia-win32
            push_tag: nvidia-win32
          - name: nvidia-py311
            target: python
            arch: win64
            make_target: build-nvidia-py311
            push_tag: nvidia-py311
          - name: nvidia-win32-py311
            target: python
            arch: win32
            make_target: build-nvidia-win32-py311
            push_tag: nvidia-win32-py311
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Build ${{ matrix.variant.name }}
        run: |
          make ${{ matrix.variant.make_target }} USE_CN_MIRRORS=0 USE_CN_MIRRORS=0

      - name: Push ${{ matrix.variant.push_tag }}
        run: |
          docker push ${{ env.REGISTRY }}:${{ env.IMAGE_NAME }}_${{ matrix.variant.push_tag }}

      - name: Tag and push with release version
        if: github.event.release.tag_name != ''
        run: |
          docker tag ${{ env.REGISTRY }}:${{ env.IMAGE_NAME }}_${{ matrix.variant.push_tag }} \
                     ${{ env.REGISTRY }}:${{ env.IMAGE_NAME }}_${{ matrix.variant.push_tag }}-${{ github.event.release.tag_name }}
          docker push ${{ env.REGISTRY }}:${{ env.IMAGE_NAME }}_${{ matrix.variant.push_tag }}-${{ github.event.release.tag_name }}

  # Build matrix for wine-10 (from source)
  build-wine10:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant:
          - name: ubuntu-wine10
            target: ubuntu-base
            arch: win64
            make_target: build-ubuntu-wine10
            push_tag: ubuntu-wine10
          - name: ubuntu-wine10-win32
            target: ubuntu-base
            arch: win32
            make_target: build-ubuntu-wine10-win32
            push_tag: ubuntu-wine10-win32
          - name: ubuntu-wine10-py311
            target: python
            arch: win64
            make_target: build-ubuntu-wine10-py311
            push_tag: ubuntu-wine10-py311
          - name: ubuntu-wine10-win32-py311
            target: python
            arch: win32
            make_target: build-ubuntu-wine10-win32-py311
            push_tag: ubuntu-wine10-win32-py311
          - name: nvidia-wine10
            target: ubuntu-base
            arch: win64
            make_target: build-nvidia-wine10
            push_tag: nvidia-wine10
          - name: nvidia-wine10-win32
            target: ubuntu-base
            arch: win32
            make_target: build-nvidia-wine10-win32
            push_tag: nvidia-wine10-win32
          - name: nvidia-wine10-py311
            target: python
            arch: win64
            make_target: build-nvidia-wine10-py311
            push_tag: nvidia-wine10-py311
          - name: nvidia-wine10-win32-py311
            target: python
            arch: win32
            make_target: build-nvidia-wine10-win32-py311
            push_tag: nvidia-wine10-win32-py311
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Build ${{ matrix.variant.name }}
        run: |
          make ${{ matrix.variant.make_target }} USE_CN_MIRRORS=0 USE_CN_MIRRORS=0

      - name: Push ${{ matrix.variant.push_tag }}
        run: |
          docker push ${{ env.REGISTRY }}:${{ env.IMAGE_NAME }}_${{ matrix.variant.push_tag }}

      - name: Tag and push with release version
        if: github.event.release.tag_name != ''
        run: |
          docker tag ${{ env.REGISTRY }}:${{ env.IMAGE_NAME }}_${{ matrix.variant.push_tag }} \
                     ${{ env.REGISTRY }}:${{ env.IMAGE_NAME }}_${{ matrix.variant.push_tag }}-${{ github.event.release.tag_name }}
          docker push ${{ env.REGISTRY }}:${{ env.IMAGE_NAME }}_${{ matrix.variant.push_tag }}-${{ github.event.release.tag_name }}

  # Build with China mirrors (optional)
  build-cn:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[cn-mirror]') || contains(github.event.head_commit.message, 'build-cn')
    strategy:
      matrix:
        variant:
          - name: latest-cn
            make_target: build-cn
            push_tag: latest-cn
          - name: ubuntu-py311-cn
            make_target: build-ubuntu-py311-cn
            push_tag: ubuntu-py311-cn
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Build ${{ matrix.variant.name }} with China mirrors
        run: |
          make ${{ matrix.variant.make_target }} USE_CN_MIRRORS=1

      - name: Push ${{ matrix.variant.push_tag }}
        run: |
          docker push ${{ env.REGISTRY }}:${{ env.IMAGE_NAME }}_${{ matrix.variant.push_tag }}

  # Summary job
  summary:
    runs-on: ubuntu-latest
    needs: [build-stable, build-wine10]
    if: always()
    steps:
      - name: Build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All Docker images have been built and pushed to Aliyun Container Registry." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Images (Wine 11 - Stable)" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_latest" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_ubuntu-win32" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_ubuntu-py311" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_ubuntu-win32-py311" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_nvidia" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_nvidia-win32" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_nvidia-py311" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_nvidia-win32-py311" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Images (Wine 10)" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_ubuntu-wine10" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_ubuntu-wine10-win32" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_ubuntu-wine10-py311" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_ubuntu-wine10-win32-py311" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_nvidia-wine10" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_nvidia-wine10-win32" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_nvidia-wine10-py311" >> $GITHUB_STEP_SUMMARY
          echo "- registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_nvidia-wine10-win32-py311" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Example" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull registry.cn-hangzhou.aliyuncs.com/tekintian/dev:wine_latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
